import os
import asyncio
import traceback
import logging
import re
import signal
import sys
import json
from datetime import datetime
from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiohttp import web, ClientSession

# --- –°–ò–°–¢–ï–ú–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò ---
# –û—Ç–∫–ª—é—á–∞–µ–º —Å–∏–≥–Ω–∞–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å –Ω–∞ Render
if sys.platform != 'win32':
    signal.signal(signal.SIGALRM, signal.SIG_IGN)
    signal.signal(signal.SIGCHLD, signal.SIG_IGN)

# –ò–º–ø–æ—Ä—Ç Cerebras SDK —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
try:
    from cerebras.cloud.sdk import AsyncCerebras
    CEREBRAS_AVAILABLE = True
except ImportError:
    CEREBRAS_AVAILABLE = False

# --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
TOKEN = os.getenv("BOT_TOKEN")
AI_KEY = os.getenv("AI_API_KEY")

# –û—Å–Ω–æ–≤–Ω—ã–µ ID –∏ —Å—Å—ã–ª–∫–∏
CHANNEL_ID = "@metaformula_life"
ADMIN_ID = 7830322013

# –°—Å—ã–ª–∫–∏ –Ω–∞ —Ä–µ—Å—É—Ä—Å—ã –ø—Ä–æ–µ–∫—Ç–∞
LOGO_URL = "https://raw.githubusercontent.com/Elektra174/meta_navigator_bot/main/logo.png"
PROTOCOL_URL = "https://raw.githubusercontent.com/Elektra174/meta_navigator_bot/main/Autopilot_System_Protocol.pdf"
PRACTICUM_URL = "https://youtube.com/playlist?list=PLyour_playlist_id" # –°—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É –∏–ª–∏ –ø–ª–µ–π–ª–∏—Å—Ç
CHANNEL_LINK = "https://t.me/metaformula_life"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[logging.StreamHandler(sys.stdout)]
)
logger = logging.getLogger(__name__)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ –∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞
bot = Bot(token=TOKEN)
dp = Dispatcher(storage=MemoryStorage())

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Cerebras AI –∫–ª–∏–µ–Ω—Ç–∞
ai_client = None
if AI_KEY and CEREBRAS_AVAILABLE:
    try:
        ai_client = AsyncCerebras(api_key=AI_KEY)
        logger.info("‚úÖ Cerebras AI Engine: ONLINE (Identity Lab v4.8)")
    except Exception as e:
        logger.error(f"‚ùå AI Engine Init Error: {e}")
        ai_client = None
else:
    logger.warning("‚ö†Ô∏è Cerebras AI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω —Ä–µ–∂–∏–º –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞ (Regex Fallback).")

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∏ –∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
start_time = datetime.now()
error_count = 0
diagnostic_data = {}  # –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –≤–µ–±-–æ—Ç—á–µ—Ç–æ–≤

# –°–æ—Å—Ç–æ—è–Ω–∏—è FSM
class AuditState(StatesGroup):
    answering = State()

# --- –°–ü–ò–°–û–ö –í–û–ü–†–û–°–û–í (–ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è Identity Lab v4.8) ---
QUESTIONS = [
    # 1. –õ–æ–∫–∞—Ü–∏—è
    "üìç **–¢–æ—á–∫–∞ 1: –õ–æ–∫–∞—Ü–∏—è.**\n–í –∫–∞–∫–æ–π —Å—Ñ–µ—Ä–µ –∂–∏–∑–Ω–∏ –∏–ª–∏ –≤ –∫–∞–∫–æ–º –¥–µ–ª–µ —Ç—ã —Å–µ–π—á–∞—Å —á—É–≤—Å—Ç–≤—É–µ—à—å –ø—Ä–æ–±—É–∫—Å–æ–≤–∫—É? –û–ø–∏—à–∏ —Å–∏—Ç—É–∞—Ü–∏—é, –≥–¥–µ —Ç–≤–æ–∏ —É—Å–∏–ª–∏—è –Ω–µ –¥–∞—é—Ç —Ç–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π —Ç—ã —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—à—å.",
    
    # 2. –ú–µ—Ç–∞-–ú–∞—è–∫
    "üìç **–¢–æ—á–∫–∞ 2: –ú–µ—Ç–∞-–ú–∞—è–∫.**\n–ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ –∑–∞–¥–∞—á–∞ —Ä–µ—à–µ–Ω–∞ –Ω–∞ 100%. –û–ø–∏—à–∏ —Å–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ —ç—Ç–æ–π —Ç–æ—á–∫–µ: –∫–∞–∫–æ–π —Ç—ã —Ç–µ–ø–µ—Ä—å? –ü–æ–¥–±–µ—Ä–∏ 3‚Äì4 —Å–ª–æ–≤–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: —Å–ø–æ–∫–æ–π–Ω—ã–π, –º–æ—â–Ω—ã–π, —Å–≤–æ–±–æ–¥–Ω—ã–π). –ö–∞–∫ —Ç—ã —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—à—å –∏ –∫–∞–∫ —Ç–µ–ø–µ—Ä—å —Å–º–æ—Ç—Ä–∏—à—å –Ω–∞ –º–∏—Ä?",
    
    # 3. –ê—Ä—Ö–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º
    "üìç **–¢–æ—á–∫–∞ 3: –ê—Ä—Ö–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º.**\n–ö–∞–∫–∞—è ¬´–º—ã—Å–ª–∏—Ç–µ–ª—å–Ω–∞—è –∂–≤–∞—á–∫–∞¬ª –∫—Ä—É—Ç–∏—Ç—Å—è —É —Ç–µ–±—è –≤ –≥–æ–ª–æ–≤–µ, –∫–æ–≥–¥–∞ —Ç—ã –¥—É–º–∞–µ—à—å –æ –ø–µ—Ä–µ–º–µ–Ω–∞—Ö? –ö–∞–∫–∏–µ —Å–æ–º–Ω–µ–Ω–∏—è –∏–ª–∏ –¥–æ–≤–æ–¥—ã —Ç—ã —Å–µ–±–µ –ø—Ä–∏–≤–æ–¥–∏—à—å, —á—Ç–æ–±—ã –æ–ø—Ä–∞–≤–¥–∞—Ç—å —Ç–µ–∫—É—â—É—é —Å–∏—Ç—É–∞—Ü–∏—é?",
    
    # 4. –°—Ü–µ–Ω–∞
    "üìç **–¢–æ—á–∫–∞ 4: –°—Ü–µ–Ω–∞.**\n–ü—Ä–µ–¥—Å—Ç–∞–≤—å –ø–µ—Ä–µ–¥ —Å–æ–±–æ–π –ø—É—Å—Ç—É—é —Å—Ü–µ–Ω—É –∏ –≤—ã–Ω–µ—Å–∏ –Ω–∞ –Ω–µ—ë —Ç–æ, —á—Ç–æ —Ç–µ–±–µ –º–µ—à–∞–µ—Ç. –ï—Å–ª–∏ –±—ã –æ–Ω–æ –±—ã–ª–æ –æ–±—Ä–∞–∑–æ–º –∏–ª–∏ –ø—Ä–µ–¥–º–µ—Ç–æ–º... –Ω–∞ —á—Ç–æ –±—ã –æ–Ω–æ –º–æ–≥–ª–æ –±—ã—Ç—å –ø–æ—Ö–æ–∂–µ? (–ù–∞–ø—Ä–∏–º–µ—Ä: —Å—Ç–µ–Ω–∞, —Ç—É–º–∞–Ω, —Ç—è–∂–µ–ª—ã–π —à–∞—Ä?)",
    
    # 5. –î–µ—Ç–µ–∫—Ü–∏—è —Å–∏–≥–Ω–∞–ª–∞
    "üìç **–¢–æ—á–∫–∞ 5: –î–µ—Ç–µ–∫—Ü–∏—è —Å–∏–≥–Ω–∞–ª–∞.**\n–ü–æ—Å–º–æ—Ç—Ä–∏ –Ω–∞ —ç—Ç–æ—Ç –ø—Ä–µ–¥–º–µ—Ç –Ω–∞ —Å—Ü–µ–Ω–µ. –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —Ç–≤–æ–µ–º —Ç–µ–ª–µ, –∫–æ–≥–¥–∞ —Ç—ã –µ–≥–æ –Ω–∞–±–ª—é–¥–∞–µ—à—å? –ì–¥–µ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –æ—Ç–∫–ª–∏–∫ (—Å–∂–∞—Ç–∏–µ, —Ö–æ–ª–æ–¥, –∫–æ–º)? –û–ø–∏—à–∏, —á—Ç–æ –∏–º–µ–Ω–Ω–æ —Ç—ã —Å–µ–π—á–∞—Å –¥–µ–ª–∞–µ—à—å —Å–æ —Å–≤–æ–∏–º —Ç–µ–ª–æ–º: –º–æ–∂–µ—Ç, –Ω–∞–ø—Ä—è–≥–∞–µ—à—å –º—ã—à—Ü—ã, –∑–∞–¥–µ—Ä–∂–∏–≤–∞–µ—à—å –¥—ã—Ö–∞–Ω–∏–µ –∏–ª–∏ —Ö–æ—á–µ—à—å –æ—Ç–≤–µ—Ä–Ω—É—Ç—å—Å—è?",
    
    # 6. –ë–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –ê–ª–∏–±–∏
    "üìç **–¢–æ—á–∫–∞ 6: –ë–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –ê–ª–∏–±–∏.**\n–¢–≤–æ–µ —Ç–µ–ª–æ –≤—Å–µ–≥–¥–∞ –¥–µ–π—Å—Ç–≤—É–µ—Ç –ª–æ–≥–∏—á–Ω–æ. –ö–∞–∫ —Ç—ã –¥—É–º–∞–µ—à—å, –æ—Ç —á–µ–≥–æ —Ç–µ–±—è –ø—ã—Ç–∞–µ—Ç—Å—è –∑–∞—â–∏—Ç–∏—Ç—å –∏–ª–∏ —É–±–µ—Ä–µ—á—å —ç—Ç–∞ —Ç–µ–ª–µ—Å–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è –ø—Ä–∏ –≤–∑–≥–ª—è–¥–µ –Ω–∞ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ? (–ù–∞–ø—Ä–∏–º–µ—Ä: –æ—Ç —Ä–∏—Å–∫–∞, –æ—Ç –ª–∏—à–Ω–∏—Ö —Ç—Ä–∞—Ç —ç–Ω–µ—Ä–≥–∏–∏ –∏–ª–∏ –æ—Ç —á—É–∂–æ–≥–æ –º–Ω–µ–Ω–∏—è?)",
    
    # 7. –†–µ–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
    "üìç **–¢–æ—á–∫–∞ 7: –¢–µ–Ω–µ–≤–æ–π —Ä–µ—Å—É—Ä—Å.**\n–ö–∞–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –≤ –ø–æ–≤–µ–¥–µ–Ω–∏–∏ –¥—Ä—É–≥–∏—Ö –ª—é–¥–µ–π —Ç–µ–±—è —Ä–∞–∑–¥—Ä–∞–∂–∞–µ—Ç —Å–∏–ª—å–Ω–µ–µ –≤—Å–µ–≥–æ? –ï—Å–ª–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å, —á—Ç–æ –∑–∞ —ç—Ç–∏–º –∫–∞—á–µ—Å—Ç–≤–æ–º —Å—Ç–æ–∏—Ç –∫–∞–∫–∞—è-—Ç–æ —Å–∫—Ä—ã—Ç–∞—è —Å–∏–ª–∞ ‚Äî –∫–∞–∫ —Ç—ã –¥—É–º–∞–µ—à—å, —á—Ç–æ —ç—Ç–æ –∑–∞ —Å–∏–ª–∞? –ò –∫–∞–∫ –±—ã —Ç—ã –º–æ–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ—ë —Å–µ–±–µ –Ω–∞ –ø–æ–ª—å–∑—É?",
    
    # 8. –ö–æ–º–∞–Ω–¥–∞ –ê–≤—Ç–æ—Ä–∞
    "üìç **–¢–æ—á–∫–∞ 8: –ö–æ–º–∞–Ω–¥–∞ –ê–≤—Ç–æ—Ä–∞.**\n–¢—ã –≥–æ—Ç–æ–≤ –ø—Ä–∏–∑–Ω–∞—Ç—å —Å–µ–±—è –ê–≤—Ç–æ—Ä–æ–º —Ç–æ–≥–æ, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —Ç–≤–æ–µ–º —Ç–µ–ª–µ –∏ —Ç–≤–æ–µ–π –∂–∏–∑–Ω–∏, –∏ –ø–µ—Ä–µ–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∞–≤—Ç–æ–ø–∏–ª–æ—Ç –Ω–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é —Ç–≤–æ–∏—Ö –∑–∞–º—ã—Å–ª–æ–≤ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å?"
]

# --- HTML –®–ê–ë–õ–û–ù –î–õ–Ø –í–ï–ë-–û–¢–ß–ï–¢–ê ---
HTML_TEMPLATE = """
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Identity Lab Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Roboto+Mono:wght@400&display=swap" rel="stylesheet">
    <style>
        :root {{ --bg: #050505; --gold: #D4AF37; --text: #e5e5e5; }}
        body {{ background-color: var(--bg); color: var(--text); font-family: 'Rajdhani', sans-serif; }}
        .card {{ background: rgba(20,20,20,0.95); border: 1px solid #333; border-left: 4px solid var(--gold); padding: 24px; border-radius: 8px; margin-bottom: 24px; }}
        .mono {{ font-family: 'Roboto Mono', monospace; }}
        .btn {{ background: linear-gradient(to right, #b4932c, #D4AF37); color: black; font-weight: bold; padding: 12px 24px; border-radius: 6px; text-transform: uppercase; display: inline-block; }}
        .btn:hover {{ opacity: 0.9; }}
    </style>
</head>
<body class="p-4 md:p-8 max-w-4xl mx-auto">
    <header class="text-center mb-12 border-b border-gray-800 pb-8">
        <h1 class="text-4xl md:text-6xl font-bold text-gold mb-2">IDENTITY LAB</h1>
        <p class="text-xl text-gray-400">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ: {user_name}</p>
        <p class="text-sm text-gray-600 mt-2 mono">ID: {user_id} | DATE: {date}</p>
    </header>
    
    <main>
        <div class="card">
            <h2 class="text-2xl font-bold text-white mb-6 border-b border-gray-800 pb-2">–ù–ï–ô–†–û-–°–ò–ù–¢–ï–ó –î–ê–ù–ù–´–•</h2>
            <div class="mono whitespace-pre-wrap leading-relaxed text-gray-300 text-sm md:text-base">
{report_text}
            </div>
        </div>

        <div class="text-center mt-12 space-y-4">
            <p class="text-gray-400 mb-4">–î–ª—è –ø–æ–ª–Ω–æ–π –∏–Ω—Å—Ç–∞–ª–ª—è—Ü–∏–∏ –Ω–æ–≤–æ–π –ò–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫ –≤–∏–¥–µ–æ-–ø—Ä–∞–∫—Ç–∏–∫—É–º—É:</p>
            <a href="{practicum_link}" class="btn transform transition hover:scale-105">
                –ê–ö–¢–ò–í–ò–†–û–í–ê–¢–¨ –ò–î–ï–ù–¢–ò–ß–ù–û–°–¢–¨
            </a>
            <div class="mt-4">
                <a href="{protocol_link}" class="text-[#D4AF37] hover:underline text-sm mono">–°–∫–∞—á–∞—Ç—å PDF –ü—Ä–æ—Ç–æ–∫–æ–ª</a>
            </div>
        </div>
    </main>

    <footer class="mt-16 text-center text-xs text-gray-600 mono border-t border-gray-900 pt-8">
        ¬© 2026 META-FORMULA | ALEXANDER LAZARENKO
    </footer>
</body>
</html>
"""

# --- –°–ò–°–¢–ï–ú–ù–´–ô –ü–†–û–ú–ü–¢ –ò–ò ---
SYSTEM_PROMPT = """–¢–´ ‚Äî –°–¢–ê–†–®–ò–ô –ê–†–•–ò–¢–ï–ö–¢–û–† –ò–î–ï–ù–¢–ò–ß–ù–û–°–¢–ò IDENTITY LAB.
–ó–ê–î–ê–ß–ê: –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞—É–¥–∏—Ç–∞.

–õ–û–ì–ò–ö–ê –û–¢–ß–ï–¢–ê (–°–¢–†–û–ì–û):
‚¨õÔ∏è [–¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï: –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ê–í–¢–û–ü–ò–õ–û–¢–ê] üìÄ

–°—Ç–∞—Ç—É—Å: –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ç–æ–∫–∞ —ç–Ω–µ—Ä–≥–∏–∏ –≤ –∫–æ–Ω—Ç—É—Ä–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏. –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ä–µ–∂–∏–º–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏–≤—ã—á–Ω–æ–≥–æ —Ä–∞–≤–Ω–æ–≤–µ—Å–∏—è (–≥–æ–º–µ–æ—Å—Ç–∞–∑–∞).

üìä –ò–ù–î–ï–ö–° –ê–í–¢–û–ú–ê–¢–ò–ó–ú–ê (–ò–Ω–µ—Ä—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö –Ω–µ–π—Ä–æ–Ω–Ω—ã—Ö —Å–≤—è–∑–µ–π): [X]%

üß† –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ö–û–ù–¢–£–†–û–í –°–ò–°–¢–ï–ú–´:

1. –£–ó–ï–õ –°–û–ü–†–û–¢–ò–í–õ–ï–ù–ò–Ø (–û–±—Ä–∞–∑ –∏ –°–∏–≥–Ω–∞–ª):
–í–∞—à–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ –ø—Ä–∏–Ω—è–ª–æ —Ñ–æ—Ä–º—É "[–æ—Ç–≤–µ—Ç 4]". –ù–∞–±–ª—é–¥–∞—è –µ–≥–æ, –≤—ã —Ñ–∏–∑–∏—á–µ—Å–∫–∏ "[–æ—Ç–≤–µ—Ç 5]". –≠—Ç–æ –≤–∞—à–µ –∞–∫—Ç–∏–≤–Ω–æ–µ –∞–≤—Ç–æ—Ä—Å–∫–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –∏–º–ø—É–ª—å—Å–∞. –°–∏—Å—Ç–µ–º–∞ —Ç—Ä–∞—Ç–∏—Ç —Ä–µ—Å—É—Ä—Å –Ω–∞ —É–¥–µ—Ä–∂–∞–Ω–∏–µ —ç—Ç–æ–≥–æ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è.

2. –•–û–õ–û–°–¢–û–ô –•–û–î (–î–°–ú ‚Äî –î–µ—Ñ–æ–ª—Ç-—Å–∏—Å—Ç–µ–º–∞ –º–æ–∑–≥–∞):
–ú—ã—Å–ª–∏ "[–æ—Ç–≤–µ—Ç 3]" ‚Äî —ç—Ç–æ —Ä–∞–±–æ—Ç–∞ –ë–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –ê–ª–∏–±–∏. –í–∞—à–∞ –î–°–ú —É—Ç–∏–ª–∏–∑–∏—Ä—É–µ—Ç 80% —ç–Ω–µ—Ä–≥–∏–∏ –Ω–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫—É —ç—Ç–∏—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤, —á—Ç–æ–±—ã —É —Å–∏—Å—Ç–µ–º—ã –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å —Å–∏–ª –Ω–∞ –≤—ã—Ö–æ–¥ –≤ ¬´–æ–ø–∞—Å–Ω—É—é¬ª –∑–æ–Ω—É —Ä–æ—Å—Ç–∞ (–º–æ–∑–≥ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—Ç –Ω–æ–≤–æ–µ –∫–∞–∫ —É–≥—Ä–æ–∑—É). –≠—Ç–æ –Ω–µ –æ—à–∏–±–∫–∞, –∞ —Ä–∞–±–æ—Ç–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∞–Ω—Ç–∏–≤–∏—Ä—É—Å–∞.

3. –†–ï–ê–ö–¢–û–† –ò–î–ï–ù–¢–ò–ß–ù–û–°–¢–ò (–°–∫—Ä—ã—Ç—ã–π —Ä–µ—Å—É—Ä—Å):
–†–∞–∑–¥—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ "[–∫–∞—á–µ—Å—Ç–≤–æ –∏–∑ –æ—Ç–≤–µ—Ç–∞ 7]" —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Å–∫—Ä—ã—Ç—É—é —Å–∏–ª—É: "[—Å–∏–ª–∞ –∏–∑ –æ—Ç–≤–µ—Ç–∞ 7]". –ü—Ä—è–º–æ —Å–µ–π—á–∞—Å —ç—Ç–∞ —Å–∏–ª–∞ –∑–∞–ø–µ—Ä—Ç–∞ –≤ –∑–∞–∂–∏–º–µ [–æ—Ç–≤–µ—Ç 5]. –ú—ã –Ω–µ –±—É–¥–µ–º –±–æ—Ä–æ—Ç—å—Å—è —Å —Ä–∞–∑–¥—Ä–∞–∂–µ–Ω–∏–µ–º ‚Äî –º—ã –∑–∞–±–µ—Ä–µ–º –∏–∑ –Ω–µ–≥–æ —Ä–µ—Å—É—Ä—Å.

4. –ú–ï–¢–ê-–ú–ê–Ø–ö (–≠—Ç–∞–ª–æ–Ω–Ω–∞—è –∏–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—å):
–í–∞—à–∞ —ç—Ç–∞–ª–æ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è ‚Äî [–æ—Ç–≤–µ—Ç 2]. –í —ç—Ç–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –≤–∞—à–µ –¥—ã—Ö–∞–Ω–∏–µ —Ä–æ–≤–Ω–æ–µ, –∞ –≤–∑–≥–ª—è–¥ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω –∑–∞ –ø—Ä–µ–¥–µ–ª—ã "[–æ—Ç–≤–µ—Ç 4]".

üõ† –ú–ò–ù–ò-–ü–†–ê–ö–¢–ò–ö–£–ú: –†–ï–ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –°–ò–õ–´ (–ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –°–¥–≤–∏–≥)
*–í—ã–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–æ—Ç –∞–ª–≥–æ—Ä–∏—Ç–º –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å:*
1. –î–µ—Ç–µ–∫—Ü–∏—è: –°–Ω–æ–≤–∞ –ø–æ—Å–º–æ—Ç—Ä–∏ –Ω–∞ –æ–±—Ä–∞–∑ "[–æ—Ç–≤–µ—Ç 4]" –Ω–∞ —Å—Ü–µ–Ω–µ. –ó–∞–º–µ—Ç—å –∑–∞–∂–∏–º –≤ —Ç–µ–ª–µ.
2. –ê–≤—Ç–æ—Ä—Å—Ç–≤–æ: –°–∫–∞–∂–∏ —Å–µ–±–µ: ¬´–≠—Ç–æ –Ø —Å–µ–π—á–∞—Å —Å–∂–∏–º–∞—é [–º–∞—Ä–∫–µ—Ä] –∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –¥—ã—Ö–∞–Ω–∏–µ, —á—Ç–æ–±—ã –∑–∞—â–∏—Ç–∏—Ç—å —Å–≤–æ–π –ø–æ–∫–æ–π. –≠—Ç–æ –ú–û–Ø —ç–Ω–µ—Ä–≥–∏—è¬ª.
3. –†–µ–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è: –ü—Ä–µ–¥—Å—Ç–∞–≤—å, –∫–∞–∫ –µ—Å–ª–∏ –±—ã —Ç—ã –∑–∞–±–∏—Ä–∞–ª —Å–∏–ª—É, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤ —ç—Ç–æ–º –æ–±—Ä–∞–∑–µ, –æ–±—Ä–∞—Ç–Ω–æ –≤ —Ç–µ–ª–æ.
4. –°–¥–≤–∏–≥: –ü–æ–∑–≤–æ–ª—å –ø–ª–µ—á–∞–º —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å—Å—è. –ü—Ä–µ–¥—Å—Ç–∞–≤—å, –∫–∞–∫ –æ–±—Ä–∞–∑ —Ä–∞—Å—Ç–≤–æ—Ä—è–µ—Ç—Å—è. –ü–æ—á—É–≤—Å—Ç–≤—É–π —Å–µ–±—è [–†–æ–ª—å –∏–∑ –æ—Ç–≤–µ—Ç–∞ 2].

‚ö°Ô∏è –ö–û–î –ü–ï–†–ï–ü–†–û–®–ò–í–ö–ò (–ú–ï–¢–ê–§–û–†–ú–£–õ–ê):
> ¬´–Ø –ê–≤—Ç–æ—Ä. –Ø –ü–†–ò–ó–ù–ê–Æ, —á—Ç–æ —Å–∞–º —Å–æ–∑–¥–∞—é —ç—Ç–æ—Ç —Å–∏–≥–Ω–∞–ª [–æ—Ç–≤–µ—Ç 5] ‚Äî —ç—Ç–æ –º–æ–π —Ä–µ—Å—É—Ä—Å. –Ø –ù–ê–ü–†–ê–í–õ–Ø–Æ –µ–≥–æ –Ω–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏—é –≠—Ç–∞–ª–æ–Ω–Ω–æ–π –ò–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç–∏ [–æ—Ç–≤–µ—Ç 2]¬ª.

[üéØ –î–ê–õ–¨–ù–ï–ô–®–ê–Ø –î–ò–†–ï–ö–¢–ò–í–ê]:
1. –ò–∑—É—á–∏—Ç–µ –ì–∞–π–¥ (PDF –Ω–∏–∂–µ).
2. –ß—Ç–æ–±—ã —ç—Ç–æ—Ç –°–¥–≤–∏–≥ –Ω–µ ¬´–∑–∞–º—ã–ª–∏–ª—Å—è¬ª —Å–∏—Å—Ç–µ–º–æ–π –≤ —Ç–µ—á–µ–Ω–∏–µ –±–ª–∏–∂–∞–π—à–∏—Ö 4 —á–∞—Å–æ–≤ (–æ–∫–Ω–æ –ø–ª–∞—Å—Ç–∏—á–Ω–æ—Å—Ç–∏ –¥–ª—è –∑–∞–ø–∏—Å–∏ –Ω–æ–≤–æ–≥–æ –æ–ø—ã—Ç–∞), –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞ –≥–ª—É–±–æ–∫–∞—è —Å–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω—Å—Ç–∞–ª–ª—è—Ü–∏—è. –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫ –í–∏–¥–µ–æ-–ø—Ä–∞–∫—Ç–∏–∫—É–º—É –Ω–∏–∂–µ.

–°–¢–ò–õ–¨: –î–∏—Ä–µ–∫—Ç–∏–≤–Ω—ã–π, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π, –Ω–∞—É—á–Ω—ã–π. –ù–∏–∫–∞–∫–æ–π "–≤–æ–¥—ã".
"""

# --- –õ–û–ö–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –ê–ù–ê–õ–ò–ó–ê (FALLBACK) ---
# –≠—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç, –µ—Å–ª–∏ –ò–ò –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.

def calculate_automatism_index(answers):
    """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∏–Ω–¥–µ–∫—Å –∞–≤—Ç–æ–º–∞—Ç–∏–∑–º–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–∫—Å—Ç–∞ (–µ—Å–ª–∏ –ò–ò –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)"""
    text = " ".join(answers).lower()
    # –ú–∞—Ä–∫–µ—Ä—ã –∑–∞—Å—Ç–æ—è –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–º–∞
    stagnation_markers = [
        '–Ω–µ –∑–Ω–∞—é', '–±–æ—é—Å—å', '—Å—Ç—Ä–∞—Ö', '–ª–µ–Ω—å', '—Å–æ–º–Ω–µ–≤–∞—é—Å—å', '—Ç—É–ø–∏–∫', 
        '–Ω–µ—Ç —Å–∏–ª', '–∞–ø–∞—Ç–∏—è', '—Ç—è–∂–µ–ª–æ', '–Ω–µ –º–æ–≥—É', '—Å–∂–∏–º–∞–µ—Ç', '–¥–∞–≤–∏—Ç',
        '–∫–æ–º', '—Ö–æ–ª–æ–¥', '—Ç—Ä–µ–≤–æ–≥–∞', '–ø–∞–Ω–∏–∫–∞', '–∂–¥—É', '–æ—Ç–∫–ª–∞–¥—ã–≤–∞—é'
    ]
    # –ë–∞–∑–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å 65% + –¥–æ–±–∞–≤–∫–∞ –∑–∞ –∫–∞–∂–¥–æ–µ —Å–ª–æ–≤–æ-–º–∞—Ä–∫–µ—Ä
    count = sum(1 for m in stagnation_markers if m in text)
    base = 65
    index = base + (count * 3)
    return min(95, max(50, index)) # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –æ—Ç 50 –¥–æ 95%

def extract_key_phrase(text, max_words=5):
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–ª—é—á–µ–≤—É—é —Ñ—Ä–∞–∑—É (–ø–µ—Ä–≤—ã–µ N —Å–ª–æ–≤) –¥–ª—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏"""
    if not text: return "—Å–∏–≥–Ω–∞–ª"
    words = text.split()
    return " ".join(words[:max_words]) + ("..." if len(words) > max_words else "")

def generate_fallback_report(answers):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ –ë–ï–ó –ò–ò (—à–∞–±–ª–æ–Ω–Ω–∞—è —Å–±–æ—Ä–∫–∞)"""
    # –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —Å–ø–∏—Å–∫–∞ (–µ—Å–ª–∏ –æ—Ç–≤–µ—Ç–æ–≤ –º–µ–Ω—å—à–µ 8)
    safe_answers = answers + ["..."] * (8 - len(answers))
    
    index = calculate_automatism_index(answers)
    
    # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    location = safe_answers[0]
    beacon_state = safe_answers[1] # –ú–µ—Ç–∞-–ú–∞—è–∫
    dmn_thoughts = safe_answers[2] # –ú—ã—Å–ª–∏
    image = safe_answers[3]        # –û–±—Ä–∞–∑
    somatic = safe_answers[4]      # –°–∏–≥–Ω–∞–ª —Ç–µ–ª–∞
    shadow = safe_answers[6]       # –¢–µ–Ω—å
    
    report = f"""‚¨õÔ∏è [–¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï: –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ê–í–¢–û–ü–ò–õ–û–¢–ê] üìÄ

–°—Ç–∞—Ç—É—Å: –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ç–æ–∫–∞ —ç–Ω–µ—Ä–≥–∏–∏ –≤ –∫–æ–Ω—Ç—É—Ä–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏. –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ä–µ–∂–∏–º–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏–≤—ã—á–Ω–æ–≥–æ —Ä–∞–≤–Ω–æ–≤–µ—Å–∏—è (–≥–æ–º–µ–æ—Å—Ç–∞–∑–∞).

üìä –ò–ù–î–ï–ö–° –ê–í–¢–û–ú–ê–¢–ò–ó–ú–ê (–ò–Ω–µ—Ä—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö –Ω–µ–π—Ä–æ–Ω–Ω—ã—Ö —Å–≤—è–∑–µ–π): {index}%

üß† –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ö–û–ù–¢–£–†–û–í –°–ò–°–¢–ï–ú–´:

1. –£–ó–ï–õ –°–û–ü–†–û–¢–ò–í–õ–ï–ù–ò–Ø (–û–±—Ä–∞–∑ –∏ –°–∏–≥–Ω–∞–ª):
–í–∞—à–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ –ø—Ä–∏–Ω—è–ª–æ —Ñ–æ—Ä–º—É "{image}". –ù–∞–±–ª—é–¥–∞—è –µ–≥–æ, –≤—ã —Ñ–∏–∑–∏—á–µ—Å–∫–∏ "{somatic}". –≠—Ç–æ –≤–∞—à–µ –∞–∫—Ç–∏–≤–Ω–æ–µ –∞–≤—Ç–æ—Ä—Å–∫–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –∏–º–ø—É–ª—å—Å–∞. –°–∏—Å—Ç–µ–º–∞ —Ç—Ä–∞—Ç–∏—Ç —Ä–µ—Å—É—Ä—Å –Ω–∞ —É–¥–µ—Ä–∂–∞–Ω–∏–µ —ç—Ç–æ–≥–æ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è.

2. –•–û–õ–û–°–¢–û–ô –•–û–î (–î–°–ú ‚Äî –î–µ—Ñ–æ–ª—Ç-—Å–∏—Å—Ç–µ–º–∞ –º–æ–∑–≥–∞):
–ú—ã—Å–ª–∏ "{safe_answers[2]}" ‚Äî —ç—Ç–æ —Ä–∞–±–æ—Ç–∞ –ë–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –ê–ª–∏–±–∏. –í–∞—à–∞ –î–°–ú —É—Ç–∏–ª–∏–∑–∏—Ä—É–µ—Ç —ç–Ω–µ—Ä–≥–∏—é –Ω–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫—É —ç—Ç–∏—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤, —á—Ç–æ–±—ã —É —Å–∏—Å—Ç–µ–º—ã –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å —Å–∏–ª –Ω–∞ –≤—ã—Ö–æ–¥ –≤ ¬´–æ–ø–∞—Å–Ω—É—é¬ª –∑–æ–Ω—É —Ä–æ—Å—Ç–∞. –≠—Ç–æ —Ä–∞–±–æ—Ç–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∞–Ω—Ç–∏–≤–∏—Ä—É—Å–∞.

3. –†–ï–ê–ö–¢–û–† –ò–î–ï–ù–¢–ò–ß–ù–û–°–¢–ò (–°–∫—Ä—ã—Ç—ã–π —Ä–µ—Å—É—Ä—Å):
–†–∞–∑–¥—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ "{shadow}" —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –≤–∞—à—É –≤—ã—Ç–µ—Å–Ω–µ–Ω–Ω—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∫ —ç–∫—Å–ø–∞–Ω—Å–∏–∏. –ü—Ä—è–º–æ —Å–µ–π—á–∞—Å —ç—Ç–∞ —Å–∏–ª–∞ –∑–∞–ø–µ—Ä—Ç–∞ –≤ –∑–∞–∂–∏–º–µ "{somatic}". –ú—ã –Ω–µ –±—É–¥–µ–º –±–æ—Ä–æ—Ç—å—Å—è —Å —Ä–∞–∑–¥—Ä–∞–∂–µ–Ω–∏–µ–º ‚Äî –º—ã –∑–∞–±–µ—Ä–µ–º –∏–∑ –Ω–µ–≥–æ —Ä–µ—Å—É—Ä—Å.

4. –ú–ï–¢–ê-–ú–ê–Ø–ö (–≠—Ç–∞–ª–æ–Ω–Ω–∞—è –∏–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—å):
–í–∞—à–∞ —ç—Ç–∞–ª–æ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è ‚Äî {beacon_state}. –í —ç—Ç–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –≤–∞—à–µ –¥—ã—Ö–∞–Ω–∏–µ —Ä–æ–≤–Ω–æ–µ, –∞ –≤–∑–≥–ª—è–¥ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π.

üõ† –ú–ò–ù–ò-–ü–†–ê–ö–¢–ò–ö–£–ú: –†–ï–ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –°–ò–õ–´ (–ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –°–¥–≤–∏–≥)
*–í—ã–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–æ—Ç –∞–ª–≥–æ—Ä–∏—Ç–º –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å:*
1. –î–µ—Ç–µ–∫—Ü–∏—è: –°–Ω–æ–≤–∞ –ø–æ—Å–º–æ—Ç—Ä–∏ –Ω–∞ –æ–±—Ä–∞–∑ "{image}" –Ω–∞ —Å—Ü–µ–Ω–µ. –ó–∞–º–µ—Ç—å –∑–∞–∂–∏–º –≤ —Ç–µ–ª–µ.
2. –ê–≤—Ç–æ—Ä—Å—Ç–≤–æ: –°–∫–∞–∂–∏ —Å–µ–±–µ: ¬´–≠—Ç–æ –Ø —Å–µ–π—á–∞—Å —Å–æ–∑–¥–∞—é {somatic}, —á—Ç–æ–±—ã –∑–∞—â–∏—Ç–∏—Ç—å —Å–≤–æ–π –ø–æ–∫–æ–π. –≠—Ç–æ –ú–û–Ø —ç–Ω–µ—Ä–≥–∏—è¬ª.
3. –†–µ–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è: –ü—Ä–µ–¥—Å—Ç–∞–≤—å, –∫–∞–∫ –µ—Å–ª–∏ –±—ã —Ç—ã –∑–∞–±–∏—Ä–∞–ª —Å–∏–ª—É, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤ —ç—Ç–æ–º –æ–±—Ä–∞–∑–µ, –æ–±—Ä–∞—Ç–Ω–æ –≤ —Ç–µ–ª–æ.
4. –°–¥–≤–∏–≥: –ü–æ–∑–≤–æ–ª—å—Ç–µ –ø–ª–µ—á–∞–º —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å—Å—è. –ü—Ä–µ–¥—Å—Ç–∞–≤—å, –∫–∞–∫ –æ–±—Ä–∞–∑ —Ä–∞—Å—Ç–≤–æ—Ä—è–µ—Ç—Å—è. –ü–æ—á—É–≤—Å—Ç–≤—É–π —Å–µ–±—è: {beacon_state}.

‚ö°Ô∏è –ö–û–î –ü–ï–†–ï–ü–†–û–®–ò–í–ö–ò (–ú–ï–¢–ê–§–û–†–ú–£–õ–ê):
> ¬´–Ø –ê–≤—Ç–æ—Ä. –Ø –ü–†–ò–ó–ù–ê–Æ, —á—Ç–æ —Å–∞–º —Å–æ–∑–¥–∞—é —ç—Ç–æ—Ç —Å–∏–≥–Ω–∞–ª [{extract_key_phrase(somatic)}] ‚Äî —ç—Ç–æ –º–æ–π —Ä–µ—Å—É—Ä—Å. –Ø –ù–ê–ü–†–ê–í–õ–Ø–Æ –µ–≥–æ –Ω–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏—é –≠—Ç–∞–ª–æ–Ω–Ω–æ–π –ò–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç–∏ [{extract_key_phrase(beacon_state)}]¬ª.

[üéØ –î–ê–õ–¨–ù–ï–ô–®–ê–Ø –î–ò–†–ï–ö–¢–ò–í–ê]:
1. –ò–∑—É—á–∏—Ç–µ –ì–∞–π–¥ (PDF –Ω–∏–∂–µ).
2. –ß—Ç–æ–±—ã —ç—Ç–æ—Ç –°–¥–≤–∏–≥ –Ω–µ ¬´–∑–∞–º—ã–ª–∏–ª—Å—è¬ª —Å–∏—Å—Ç–µ–º–æ–π –≤ —Ç–µ—á–µ–Ω–∏–µ –±–ª–∏–∂–∞–π—à–∏—Ö 4 —á–∞—Å–æ–≤ (–æ–∫–Ω–æ –ø–ª–∞—Å—Ç–∏—á–Ω–æ—Å—Ç–∏), –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞ –≥–ª—É–±–æ–∫–∞—è —Å–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω—Å—Ç–∞–ª–ª—è—Ü–∏—è. –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫ –í–∏–¥–µ–æ-–ø—Ä–∞–∫—Ç–∏–∫—É–º—É –Ω–∏–∂–µ.
"""
    return report

async def get_ai_report(answers):
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞: –ø—Ä–æ–±—É–µ—Ç AI, –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî Fallback"""
    if not ai_client:
        return generate_fallback_report(answers)
    
    data_str = "–î–ê–ù–ù–´–ï –ê–£–î–ò–¢–ê:\n" + "\n".join([f"T{i+1}: {a}" for i, a in enumerate(answers)])
    
    for attempt in range(3):
        try:
            resp = await ai_client.chat.completions.create(
                messages=[
                    {"role": "system", "content": SYSTEM_PROMPT},
                    {"role": "user", "content": data_str}
                ],
                model="llama-3.3-70b",
                temperature=0.4,
                max_completion_tokens=2500
            )
            content = resp.choices[0].message.content
            if content:
                return content
        except Exception as e:
            logger.error(f"AI Synthesis Error (Attempt {attempt+1}): {e}")
            await asyncio.sleep(2 ** attempt)
    
    logger.warning("AI failed after retries, using fallback.")
    return generate_fallback_report(answers)

async def check_sub(user_id):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª"""
    try:
        member = await bot.get_chat_member(chat_id=CHANNEL_ID, user_id=user_id)
        return member.status in ["member", "administrator", "creator"]
    except Exception as e:
        logger.error(f"Check sub error: {e}")
        return False # –î–ª—è —Å—Ç—Ä–æ–≥–æ—Å—Ç–∏ –ª—É—á—à–µ False, –Ω–æ –º–æ–∂–Ω–æ True –¥–ª—è —Ç–µ—Å—Ç–æ–≤

async def send_guide(message: types.Message):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ PDF –ì–∞–π–¥–∞"""
    try:
        await message.answer("üì• **–§–æ—Ä–º–∏—Ä—É—é –≤–∞—à –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –ü–∞—Å–ø–æ—Ä—Ç (–ì–∞–π–¥)...**", parse_mode="Markdown")
        async with ClientSession() as session:
            async with session.get(PROTOCOL_URL) as resp:
                if resp.status == 200:
                    pdf_data = await resp.read()
                    await message.answer_document(
                        document=types.BufferedInputFile(pdf_data, filename="–ü–†–û–¢–û–ö–û–õ_–î–ï–®–ò–§–†–û–í–ö–ò_v4.8.pdf"),
                        caption="üìò –í–∞—à –ì–∞–π–¥ –≥–æ—Ç–æ–≤.\n\n–í–Ω—É—Ç—Ä–∏ ‚Äî —Å–µ–∫—Ä–µ—Ç '–õ–æ–≤—É—à–∫–∏ –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞' –∏ –ø–æ—á–µ–º—É –ø—Ä–æ—Å—Ç–æ '–ø–æ–Ω–∏–º–∞—Ç—å' –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —Ä–æ—Å—Ç–∞."
                    )
                else:
                    raise Exception(f"Failed to download PDF: {resp.status}")
    except Exception as e:
        logger.error(f"Guide send error: {e}")
        await message.answer(f"üì• –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª –Ω–∞–ø—Ä—è–º—É—é. –°–∫–∞—á–∞–π—Ç–µ –µ–≥–æ –ø–æ —Å—Å—ã–ª–∫–µ:\n{PROTOCOL_URL}")

async def send_admin_log(user: types.User, report: str):
    """–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π –≤ –∞–¥–º–∏–Ω–∫—É"""
    try:
        if len(report) > 3500:
            report = report[:3500] + "..."
        
        await bot.send_message(
            chat_id=ADMIN_ID,
            text=f"üîî **–ù–æ–≤–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (Identity Lab v4.8)!**\nüë§ {user.full_name} (@{user.username})\n\n{report}"
        )
    except Exception as e:
        logger.error(f"Admin log error: {e}")

# --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò (HANDLERS) ---

@dp.message(Command("start"))
async def cmd_start(message: types.Message, state: FSMContext):
    await state.clear()
    is_sub = await check_sub(message.from_user.id)
    
    kb = InlineKeyboardBuilder()
    if not is_sub:
        kb.row(types.InlineKeyboardButton(text="üì¢ –í—Å—Ç—É–ø–∏—Ç—å –≤ –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—é", url=CHANNEL_LINK))
        kb.row(types.InlineKeyboardButton(text="‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É", callback_data="check"))
        caption = (
            "üëã –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é –≤ Identity Lab.\n\n"
            "–Ø ‚Äî –ú–µ—Ç–∞-–ù–∞–≤–∏–≥–∞—Ç–æ—Ä. –Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ –Ω–∞–π—Ç–∏ —Ç–æ—á–∫–∏, –≥–¥–µ —Ç—ã —Å–∞–º –±–ª–æ–∫–∏—Ä—É–µ—à—å —Å–≤–æ—é —ç–Ω–µ—Ä–≥–∏—é, –∏ –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –∏—Ö –≤ —Ç–æ–ø–ª–∏–≤–æ –¥–ª—è —Ä–æ—Å—Ç–∞.\n\n"
            "**–î–ª—è —Å—Ç–∞—Ä—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª:**"
        )
    else:
        kb.row(types.InlineKeyboardButton(text="üöÄ –ù–ê–ß–ê–¢–¨ –ê–£–î–ò–¢", callback_data="run"))
        caption = (
            "üß† –ö–æ–Ω–Ω–µ–∫—Ç–æ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω.\n\n"
            "–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –æ–±–Ω–∞—Ä—É–∂–∏—Ç—å —Ç–≤–æ–∏ —Å–∫—Ä—ã—Ç—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Ç–æ—Ä–º–æ–∂–µ–Ω–∏—è. –ì–æ—Ç–æ–≤ –∑–∞–Ω—è—Ç—å –º–µ—Å—Ç–æ –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä–∞?"
        )
    
    await message.answer_photo(LOGO_URL, caption=caption, reply_markup=kb.as_markup())

@dp.callback_query(F.data == "check")
async def check_callback(cb: types.CallbackQuery, state: FSMContext):
    if await check_sub(cb.from_user.id):
        await cb.answer("–î–æ—Å—Ç—É–ø –æ—Ç–∫—Ä—ã—Ç!")
        await cmd_start(cb.message, state)
    else:
        await cb.answer("‚ùå –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!", show_alert=True)

@dp.callback_query(F.data == "run")
async def run_callback(cb: types.CallbackQuery, state: FSMContext):
    await cb.answer()
    await state.update_data(step=0, answers=[])
    
    await cb.message.answer(
        "üî¨ **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.**\n\n"
        "–û—Ç–≤–µ—á–∞–π —á–µ—Å—Ç–Ω–æ. –¢–≤–æ—ë —Ç–µ–ª–æ ‚Äî —Å–∞–º—ã–π —Ç–æ—á–Ω—ã–π –ø—Ä–∏–±–æ—Ä, –æ–Ω–æ –Ω–µ –≤—Ä–µ—Ç, –≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç –º—ã—Å–ª–µ–π.",
        parse_mode="Markdown"
    )
    await asyncio.sleep(1)
    await cb.message.answer(QUESTIONS[0], parse_mode="Markdown")
    await state.set_state(AuditState.answering)

@dp.message(AuditState.answering)
async def process_answers(message: types.Message, state: FSMContext):
    if not message.text:
        return await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç.")
        
    data = await state.get_data()
    step = data.get('step', 0)
    answers = data.get('answers', [])
    
    answers.append(message.text.strip())
    
    next_step = step + 1
    
    if next_step < len(QUESTIONS):
        await state.update_data(step=next_step, answers=answers)
        await message.answer(QUESTIONS[next_step], parse_mode="Markdown")
    else:
        # –§–∏–Ω–∞–ª
        await message.answer("üß† **–ò–¥–µ—Ç –¥–µ—à–∏—Ñ—Ä–æ–≤–∫–∞ –≤–∞—à–µ–≥–æ –ö–æ–Ω–Ω–µ–∫—Ç–æ–º–∞...**")
        
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ (AI –∏–ª–∏ Fallback)
        report = await get_ai_report(answers)
        
        # –ù–µ–±–æ–ª—å—à–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        report = report.replace('```', '').replace('**', '*') 
        
        await message.answer(report)
        
        # –û—Ç–ø—Ä–∞–≤–∫–∞ –ì–∞–π–¥–∞
        await send_guide(message)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–µ–±-–æ—Ç—á–µ—Ç–∞
        diagnostic_data[message.from_user.id] = {
            "user": message.from_user.full_name,
            "id": message.from_user.id,
            "report": report,
            "date": datetime.now().strftime("%Y-%m-%d %H:%M")
        }

        # Upsell –Ω–∞ –ü—Ä–∞–∫—Ç–∏–∫—É–º –∏ –í–µ–±-–æ—Ç—á–µ—Ç
        kb = InlineKeyboardBuilder()
        kb.row(types.InlineKeyboardButton(text="‚ö°Ô∏è –ü–ï–†–ï–ô–¢–ò –ö –ü–†–ê–ö–¢–ò–ö–£–ú–£", url=PRACTICUM_URL))
        kb.row(types.InlineKeyboardButton(text="üìä –û–¢–ö–†–´–¢–¨ –í–ï–ë-–û–¢–ß–ï–¢", callback_data="web_report"))
        
        await asyncio.sleep(2)
        await message.answer(
            "üéØ **–ê—É–¥–∏—Ç –∑–∞–≤–µ—Ä—à–µ–Ω.**\n\n"
            "–¢—ã –ø–æ–ª—É—á–∏–ª —Å–≤–æ–π –ö–æ–¥ –¥–æ—Å—Ç—É–ø–∞. –ß—Ç–æ–±—ã –∏–Ω—Å—Ç–∞–ª–ª–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ –≤ —Ç–µ–ª–æ –∏ –Ω–∞—á–∞—Ç—å –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –∏–∑ —Ä–æ–ª–∏ –ê–≤—Ç–æ—Ä–∞ ‚Äî –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ –≤–∏–¥–µ–æ-–ø—Ä–∞–∫—Ç–∏–∫—É–º—É:",
            reply_markup=kb.as_markup()
        )
        
        # –õ–æ–≥–∏—Ä—É–µ–º
        await send_admin_log(message.from_user, report)
        await state.clear()

@dp.callback_query(F.data == "web_report")
async def web_report_cb(cb: types.CallbackQuery):
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –≤–µ–±-–æ—Ç—á–µ—Ç
    # –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –¥–æ–º–µ–Ω, –µ—Å–ª–∏ –µ—Å—Ç—å
    host = os.environ.get("RENDER_EXTERNAL_URL", f"[http://0.0.0.0](http://0.0.0.0):{os.environ.get('PORT', 8080)}")
    url = f"{host}/report/{cb.from_user.id}"
    await cb.answer()
    await cb.message.answer(f"üîó –í–∞—à–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∫–∏:\n{url}")

# --- –í–ï–ë-–°–ï–†–í–ï–† (Health Check & Report) ---
async def handle_home(request):
    return web.Response(text="Identity Lab System v4.8 Active")

async def handle_report(request):
    try:
        user_id = int(request.match_info['user_id'])
        if user_id in diagnostic_data:
            data = diagnostic_data[user_id]
            html = HTML_TEMPLATE.format(
                user_name=data['user'],
                user_id=data['id'],
                date=data['date'],
                report_text=data['report'],
                practicum_link=PRACTICUM_URL,
                protocol_link=PROTOCOL_URL
            )
            return web.Response(text=html, content_type='text/html')
        return web.Response(text="–û—Ç—á–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —É—Å—Ç–∞—Ä–µ–ª.", status=404)
    except:
        return web.Response(text="–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –æ—Ç—á–µ—Ç—É.", status=500)

async def main():
    # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∞–ø–¥–µ–π—Ç–æ–≤
    await bot.delete_webhook(drop_pending_updates=True)
    
    # –ó–∞–ø—É—Å–∫ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞
    app = web.Application()
    app.router.add_get('/', handle_home)
    app.router.add_get('/health', handle_home) # –ê–ª–∏–∞—Å –¥–ª—è health check
    app.router.add_get('/report/{user_id}', handle_report)
    
    runner = web.AppRunner(app)
    await runner.setup()
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Ä—Ç –æ—Ç Render
    port = int(os.environ.get("PORT", 8080))
    site = web.TCPSite(runner, '0.0.0.0', port)
    await site.start()
    
    logger.info(f"üöÄ Bot started via Polling on port {port}")
    
    # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
    try:
        await dp.start_polling(bot)
    except Exception as e:
        logger.error(f"Polling error: {e}")
    finally:
        await runner.cleanup()

if __name__ == "__main__":
    try:
        asyncio.run(main())
    except (KeyboardInterrupt, SystemExit):
        logger.info("Bot stopped by user")
